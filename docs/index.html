<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- â˜… PWAå‚ç…§ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«çµ±ä¸€ï¼ˆ/shower-pwa/...ï¼‰ -->
  <link rel="manifest" href="/shower-pwa/manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <link rel="apple-touch-icon" href="/shower-pwa/newicons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/shower-pwa/newicons/icon-180.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚·ãƒ£ãƒ¯ãƒ¼å®¤äºˆç´„</title>

  <style>
  /* ======ï¼ˆã“ã“ã‹ã‚‰ä¸‹ã¯å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ãã®ã¾ã¾ï¼‰====== */
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --primary:#1e40af; --primary-weak:#eff6ff; --ok:#16a34a;
    --priority-bg:#faf5ff; --priority-br:#d8cafe; --priority-text:#6d28d9;
    --panel:#f0f9ff;
    --radius:14px; --space:16px; --touch:46px; --fs:clamp(14px,1.6vw,16px);
    --active-bg:#dbeafe; --active-outline:#93c5fd66; --active-border:#3b82f6;
    --shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06);
    --confirm-bg:#d6e8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:var(--fs)}
  .hero{background:#ffffff;border-bottom:1px solid var(--line)}
  .hero-inner{max-width:1100px;margin:0 auto;padding:24px var(--space) 18px;display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
  .brand{display:flex;flex-direction:column;align-items:center;text-align:center}
  .brand .title{font-size:clamp(28px,5.6vw,44px);font-weight:900;letter-spacing:.02em}
  .brand .subtitle{margin-top:8px;color:var(--muted);font-size:14px;line-height:1.8;max-width:820px;text-align:left}
  .rule{margin-top:12px;display:grid;gap:6px;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .rule .lead{color:var(--text);background:#fff;border-radius:8px;padding:4px 2px;font-size:13px;margin-bottom:2px}
  .rule .nowtag{display:block;color:var(--text);background:var(--panel);border:1px solid #bae6fd;border-radius:8px;padding:8px 12px;margin-top:0;line-height:1.5}
  .rule small{display:none}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
  .card h3{margin:0;padding:14px 14px;border-bottom:1px solid var(--line);font-size:18px;text-align:center}
  .section{padding:12px;display:grid;gap:10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .formwrap{background:var(--panel)!important;border:1px solid #bae6fd;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:12px;border-bottom-right-radius:12px;padding:12px;display:grid;gap:12px;margin-top:-1px}
  .pills{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:10px;background:#f8fafc;border:1px dashed var(--line);color:#334155;font-size:12px}
  input{background:#fff;border:1px solid var(--line);border-radius:10px;color:#0f172a;padding:10px;min-height:var(--touch);width:100%}
  .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:#111827;border-radius:10px;padding:10px 12px;min-height:var(--touch);transition:transform .05s, box-shadow .15s}
  .btn:hover{background:#f8fafc}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#2563eb;border-color:#1d4ed8;color:#fff}
  .btn.success{background:#16a34a;border-color:#15803d;color:#fff}
  .btn.ghost{background:#fff;border-color:#d1d5db;color:#111}
  .small{font-size:12px;color:#374151}
  .note{font-size:12px;color:#6b7280;text-align:center}
  .stage h4{margin:0 0 6px 0;font-size:13px;color:#334155}
  .chips{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:12px;text-align:center;background:#fff;min-height:var(--touch);transition:box-shadow .15s, background .15s, border-color .15s, transform .05s}
  .chip:hover{background:#f1f5f9}
  .chip:active{transform:translateY(1px)}
  .chip.active{background:var(--active-bg);border-color:var(--active-border);box-shadow:0 0 0 3px var(--active-outline)}
  .chip.priority{background:var(--priority-bg);border-color:var(--priority-br);color:#6d28d9}
  .chip .subtxt{display:block;font-size:11px;color:#6d28d9;margin-top:4px}
  .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
  .slot{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px;display:flex;flex-direction:column;gap:6px;min-height:90px;transition:background .15s, outline .15s, border-color .15s}
  .slot .time{font-weight:700}
  .slot .status{margin-top:auto;font-size:12px}
  .slot .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .slot.selected{background:#eef2ff;border-color:#93c5fd;outline:2px solid #60a5fa}
  .slot.booked{opacity:.6}
  .slot.priority{background:var(--priority-bg);border-color:var(--priority-br)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #cbd5e1;border-radius:999px;font-size:12px;background:#fff}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px;display:flex;align-items:center;gap:10px;position:relative;touch-action:none}
  .item.confirmed{background:var(--confirm-bg)}
  #confirmedCard .item{ background: var(--confirm-bg) !important; }
  .item .handle{cursor:grab;border:1px dashed #cbd5e1;border-radius:8px;padding:6px 8px;font-size:12px;color:#475569;background:#f8fafc}
  .item .rank{min-width:2.5em;text-align:center;font-weight:700}
  .item .label{display:flex;flex-direction:column;gap:2px;min-width:0}
  .item .date{font-size:12px;color:#1f2937}
  .item .timeinfo{font-size:12px;color:#374151;white-space:nowrap}
  .item .fill{flex:1;min-width:0}
  .item .rm{margin-left:auto}
  .item.dragging{opacity:.95;box-shadow:0 8px 24px rgba(15,23,42,.12);cursor:grabbing}
  .placeholder{border:2px dashed #a5b4fc;border-radius:10px;height:44px;background:#f8faff}
  #finalizeWrap{margin-top:12px;text-align:center}
  #finalizeBtn{margin-top:8px;min-width:280px;box-shadow:0 8px 22px rgba(37,99,235,.28);font-weight:700}
  @media (max-width:720px){ .chips{grid-template-columns:repeat(1,1fr)} .slots{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:420px){ .slots{grid-template-columns:1fr} }
  </style>
</head>

<script>
// --- ç®¡ç†ã‚­ãƒ¼è¨­å®š ---
const ADMIN_KEY = "kagoshimauniv_peds";  // â† å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´
const ADMIN_URL = `https://osushitodonuts.github.io/shower-pwa/admin/?key=${ADMIN_KEY}`;
const STORAGE_FLAG = "sr_admin_verified";

// --- keyæ¤œè¨¼å‡¦ç† ---
(function(){
  const params = new URLSearchParams(location.search);
  const key = params.get("key");
  if (key === ADMIN_KEY) {
    // æœ‰åŠ¹ãªkeyã§é–‹ã„ãŸ â†’ è¨±å¯ã‚’ä¿å­˜
    localStorage.setItem(STORAGE_FLAG, "1");
    history.replaceState(null, "", location.origin + location.pathname); // keyã‚’URLã‹ã‚‰é™¤å»
    console.log("âœ… ç®¡ç†ç«¯æœ«ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã—ãŸ");
  } else {
    // keyãªã— or ä¸æ­£key â†’ è¨±å¯ç¢ºèª
    const verified = localStorage.getItem(STORAGE_FLAG);
    if (!verified) {
      // æœªç™»éŒ²ãªã‚‰ keyä»˜ãURLã¸å¼·åˆ¶ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      console.log("ğŸ”’ ç®¡ç†ã‚­ãƒ¼æœªç™»éŒ² â†’ èªè¨¼ãƒšãƒ¼ã‚¸ã¸è»¢é€");
      location.href = ADMIN_URL;
    }
  }
})();
</script>


<body>

  <!-- ======ï¼ˆã“ã“ã‹ã‚‰ã¯å…ƒã®HTMLãã®ã¾ã¾ï¼‰====== -->
  <section class="hero">
    <div class="hero-inner">
      <div class="brand">
        <div class="title">ã‚·ãƒ£ãƒ¯ãƒ¼å®¤äºˆç´„</div>
        <div class="subtitle">
          ãƒ»9:00â€“21:00 ã® 20 åˆ†æ ã§ã™ã€‚<br>
          ãƒ»21:00â€“ç¿Œ8:00 ã¯æŠ½é¸å¿œå‹Ÿå—ä»˜æ™‚é–“ã§ã™ï¼ˆç¬¬3å¸Œæœ›ã¾ã§ï¼‰ã€‚8:00 ä»¥é™ã¯ç©ºãæ ã®å³æ™‚äºˆç´„ãŒå¯èƒ½ã§ã™ã€‚<br>
          ãƒ»å¹³æ—¥åˆå¾Œã®ã€ŒãŠé ã‹ã‚Šå„ªå…ˆæ ã€ã¯ã€ä¿è‚²å£«ã®ä»˜ãæ·»ã„ãŒå¿…è¦ãªæ–¹ãŒå„ªå…ˆã®æ ã§ã™ã€‚
          <div class="rule">
            <div class="lead" id="leadLine">ãŸã ã„ã¾ã®æ™‚é–“ï¼ˆâ€”ï¼‰ã¯</div>
            <div class="nowtag" id="nowTag">â€”</div>
            <small id="nowJST">â€”</small>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container">
    <!-- ç¢ºå®šæ  -->
    <section class="card" id="confirmedCard" style="display:none">
      <h3>ç¢ºå®šã—ã¦ã„ã‚‹æ </h3>
      <div class="section">
        <div class="list" id="confirmedList"></div>
      </div>
    </section>

    <!-- äºˆç´„ã‚«ãƒ¼ãƒ‰ï¼ˆ20:40ä»¥é™ã¯ä¸¸ã”ã¨éè¡¨ç¤ºï¼‰ -->
    <section class="card" id="reserveCard">
      <h3>äºˆç´„</h3>
      <div class="section formwrap">
        <div class="row" style="gap:12px">
          <div style="flex:1;min-width:260px">
            <div class="small">æ°åï¼ˆåˆå›ã®ã¿ / <b>éå…¬é–‹ã§ã™</b>ï¼‰</div>
            <div class="row" style="gap:8px">
              <input id="displayName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ" />
              <button class="btn primary" id="saveName">æ°åã‚’ä¿å­˜</button>
              <button class="btn ghost" id="clearName">ã“ã®ç«¯æœ«ã‹ã‚‰å‰Šé™¤</button>
            </div>
            <div class="note" id="nameHint">æœªä¿å­˜</div>
          </div>
        </div>

        <div class="pills">
          <span class="pill">å¯¾è±¡æ—¥ï¼š<b id="targetDateLabel">â€”</b></span>
          <span class="pill">é¸æŠä¸­ï¼š<b id="selectionTrail">â€”</b></span>
        </div>

        <div class="note" id="blockedNote" style="display:none"></div>

        <div class="stage" id="stage0">
          <h4>â‘  ã‚·ãƒ£ãƒ¯ãƒ¼å®¤ã‚’é¸ã¶</h4>
          <div class="chips" id="roomChips"></div>
        </div>

        <div class="stage" id="stage1" style="display:none">
          <h4>â‘¡ åˆå‰ãƒ»åˆå¾Œã‚’é¸ã¶</h4>
          <div class="chips" id="amPmChips"></div>
        </div>

        <div class="stage" id="stage2" style="display:none">
          <h4>â‘¢ æ™‚é–“ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰ã‚’é¸ã¶</h4>
          <div class="chips" id="hourChips"></div>
        </div>

        <div class="stage" id="stage3" style="display:none">
          <div class="row">
            <h4 style="margin-right:8px">â‘£ 20åˆ†æ ã‚’é¸ã¶</h4>
            <span class="small" id="stageLabel"></span>
          </div>
          <div class="note" id="priorityNote" style="display:none">ä¿è‚²å£«ã®ä»˜ãæ·»ã„ãŒå¿…è¦ãªæ–¹ã®å„ªå…ˆæ ã§ã™ï¼ˆå¹³æ—¥ã®ã¿ï¼‰ã€‚</div>
          <div class="slots" id="slots"></div>
        </div>

        <!-- æŠ½é¸UIï¼ˆå³æ™‚æ™‚é–“ã¯å¸¸ã«éè¡¨ç¤ºï¼‰ -->
        <div class="stage" id="wishStage">
          <h4>å¸Œæœ›é †ä½ï¼ˆé•·æŠ¼ã—ã§é †ä½ã‚’å¤‰ãˆã‚‰ã‚Œã¾ã™ï¼‰</h4>
          <div class="list" id="wishList"></div>
        </div>
        <div id="finalizeWrap">
          <div class="note" id="finalizeHint">ç¬¬ï¼‘ã€œç¬¬ï¼“ã¾ã§é¸ã¶ã¨ç¢ºå®šã§ãã¾ã™ã€‚</div>
          <button class="btn primary" id="finalizeBtn">æŠ½é¸å¸Œæœ›ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>
      </div>
    </section>

  </div>

  <script>
  /* ====== ä»¥ä¸‹ã€å…ƒã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆæ©Ÿèƒ½ã¯ãã®ã¾ã¾ï¼‰ ====== */

  /* ========= è¨­å®š ========= */
  const CONFIG = {
    rooms: ["1","2"],
    slotStart: "09:00",
    slotEnd:   "21:00",
    slotMinutes: 20,
    tz: "Asia/Tokyo",
    priority: { "1": { start: "14:00", end: "16:00" }, "2": { start: "13:00", end: "16:00" } }
  };
  /* ========= ã‚­ãƒ¼ ========= */
  const KEY = { NAME:"sr_name", UID:"sr_uid", RES:"sr_reservations", LOT:"sr_lottery", PART:"sr_lot_participants" };
  const KEY_CONFIRMED_PREFIX = "sr_confirmed";
  /* ========= æ™‚åˆ»ãƒ¢ãƒƒã‚¯ ========= */
  const MOCK_PARAM = new URLSearchParams(location.search).get('mock');

  /* ========= æ—¥æœ¬ã®ç¥æ—¥ï¼ˆè¿‘ä¼¼ãƒ»æŒ¯æ›¿ãƒ»å›½æ°‘ã®ä¼‘æ—¥ï¼‰ ========= */
  function vernalEquinoxDay(year){
    if(year<=1979||year>=2100){ return 20; }
    return Math.floor(20.8431 + 0.242194*(year-1980) - Math.floor((year-1980)/4));
  }
  function autumnalEquinoxDay(year){
    if(year<=1979||year>=2100){ return 23; }
    return Math.floor(23.2488 + 0.242194*(year-1980) - Math.floor((year-1980)/4));
  }
  function nthMonday(year, month, n){
    const d = new Date(`${year}-${String(month).padStart(2,'0')}-01T00:00:00+09:00`);
    let offset = (1 - d.getDay() + 7) % 7; // 1=Mon
    return 1 + offset + (n-1)*7;
  }
  function buildJapaneseHolidaySet(year){
    const s = new Set();
    const add = (m,d)=> s.add(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
    add(1,1); add(2,11); add(2,23);
    add(4,29); add(5,3); add(5,4); add(5,5);
    add(8,11);
    add(11,3); add(11,23);
    add(1, nthMonday(year,1,2));
    add(7, nthMonday(year,7,3));
    add(9, nthMonday(year,9,3));
    add(10, nthMonday(year,10,2));
    add(3, vernalEquinoxDay(year));
    add(9, autumnalEquinoxDay(year));
    // æŒ¯æ›¿
    for(let m=1; m<=12; m++){
      for(let d=1; d<=31; d++){
        const iso = `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dt = new Date(`${iso}T00:00:00+09:00`);
        if (isNaN(dt)) continue;
        if (!s.has(iso)) continue;
        if (dt.getDay() !== 0) continue;
        let nd = new Date(dt.getTime());
        while(true){
          nd.setDate(nd.getDate()+1);
          const iso2 = `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-${String(nd.getDate()).padStart(2,'0')}`;
          const wd = nd.getDay();
          if (wd===0 || wd===6) continue;
          if (!s.has(iso2)) { s.add(iso2); break; }
        }
      }
    }
    // å›½æ°‘ã®ä¼‘æ—¥
    for(let m=1; m<=12; m++){
      for(let d=1; d<=31; d++){
        const dt = new Date(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}T00:00:00+09:00`);
        if (isNaN(dt)) continue;
        const wd = dt.getDay();
        const iso = `${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        if (s.has(iso) || wd===0 || wd===6) continue;
        const prev = new Date(dt.getTime()); prev.setDate(dt.getDate()-1);
        const next = new Date(dt.getTime()); next.setDate(dt.getDate()+1);
        const isoPrev = `${prev.getFullYear()}-${String(prev.getMonth()+1).padStart(2,'0')}-${String(prev.getDate()).padStart(2,'0')}`;
        const isoNext = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}-${String(next.getDate()).padStart(2,'0')}`;
        if (s.has(isoPrev) && s.has(isoNext)) s.add(iso);
      }
    }
    return s;
  }
  const JP_HOLIDAYS_CACHE = new Map();
  function isJapaneseHolidayISO(dateISO){
    const [y] = dateISO.split('-').map(Number);
    if (!JP_HOLIDAYS_CACHE.has(y)) JP_HOLIDAYS_CACHE.set(y, buildJapaneseHolidaySet(y));
    return JP_HOLIDAYS_CACHE.get(y).has(dateISO);
  }

  /* ========= Util ========= */
  const nowTZ = ()=> {
    if (MOCK_PARAM) return new Date(MOCK_PARAM);
    return new Date(new Date().toLocaleString('en-US', { timeZone: CONFIG.tz }));
  };
  const z2=(n)=>String(n).padStart(2,'0');
  function fmtNowHM(){ const d=nowTZ(); return `${z2(d.getHours())}:${z2(d.getMinutes())}`; }
  const toISODate = (d) => {
    const y=new Intl.DateTimeFormat('en-CA',{timeZone:CONFIG.tz,year:'numeric'}).format(d);
    const m=new Intl.DateTimeFormat('en-CA',{timeZone:CONFIG.tz,month:'2-digit'}).format(d);
    const da=new Intl.DateTimeFormat('en-CA',{timeZone:CONFIG.tz,day:'2-digit'}).format(d);
    return `${y}-${m}-${da}`;
  };
  const parseHM=(s)=>{ const [h,m]=s.split(":").map(Number); return {h,m}; };
  const addMinutes=(date,mins)=>{const d=new Date(date.getTime()); d.setMinutes(d.getMinutes()+mins);return d;};
  function isWeekday(dateISO){
    const dt = new Date(`${dateISO}T00:00:00+09:00`);
    const wd = dt.getDay();
    if (wd===0 || wd===6) return false;
    if (isJapaneseHolidayISO(dateISO)) return false;
    return true;
  }

  /* ========= Storage ========= */
  const storage = {
    getName(){return localStorage.getItem("sr_name")||"";},
    setName(v){localStorage.setItem("sr_name",v);},
    clearName(){localStorage.removeItem("sr_name");},
    getUID(){let v=localStorage.getItem("sr_uid"); if(!v){v=crypto.randomUUID(); localStorage.setItem("sr_uid",v);} return v;},
    getRes(){return JSON.parse(localStorage.getItem("sr_reservations")||"{}");},
    setRes(o){localStorage.setItem("sr_reservations",JSON.stringify(o));},
    getLot(){return JSON.parse(localStorage.getItem("sr_lottery")||"{}");},
    setLot(o){localStorage.setItem("sr_lottery",JSON.stringify(o));},
    getPart(){return JSON.parse(localStorage.getItem("sr_lot_participants")||"{}");},
    setPart(o){localStorage.setItem("sr_lot_participants",JSON.stringify(o));}
  };
  const KEY_CONFIRMED_PREFIX="sr_confirmed";
  const confirmedKey=(uid,dateISO)=>`${KEY_CONFIRMED_PREFIX}_${uid}_${dateISO}`;
  const isConfirmed=(uid,dateISO)=>localStorage.getItem(confirmedKey(uid,dateISO))==="1";
  const setConfirmed=(uid,dateISO,flag)=>{ if(flag){localStorage.setItem(confirmedKey(uid,dateISO),"1");} else{localStorage.removeItem(confirmedKey(uid,dateISO));} };

  /* ========= ãƒ¢ãƒ¼ãƒ‰ ========= */
  function currentMode(){
    const h=nowTZ().getHours();
    if (h>=8 && h<21) return "INSTANT_TODAY";
    if (h>=21) return "LOTTERY_FOR_TOMORROW";
    return "LOTTERY_FOR_TODAY";
  }
  function targetDateForMode(mode){
    const n=nowTZ(); const today=toISODate(n);
    if (mode==="INSTANT_TODAY"||mode==="LOTTERY_FOR_TODAY") return today;
    const t=new Date(n.getTime()); t.setDate(t.getDate()+1);
    return toISODate(t);
  }
  const endOfDayBlocked=()=> currentMode()==="INSTANT_TODAY" && fmtNowHM()>="20:40";

  /* ========= DOM ========= */
  const el = {
    reserveCard: document.getElementById('reserveCard'),
    confirmedCard: document.getElementById('confirmedCard'),
    confirmedList: document.getElementById('confirmedList'),
    displayName: document.getElementById('displayName'),
    saveName: document.getElementById('saveName'),
    clearName: document.getElementById('clearName'),
    nameHint: document.getElementById('nameHint'),
    leadLine: document.getElementById('leadLine'),
    nowTag: document.getElementById('nowTag'),
    targetDate: document.getElementById('targetDateLabel'),
    selectionTrail: document.getElementById('selectionTrail'),
    blockedNote: document.getElementById('blockedNote'),
    roomChips: document.getElementById('roomChips'),
    amPmChips: document.getElementById('amPmChips'),
    hourChips: document.getElementById('hourChips'),
    slots: document.getElementById('slots'),
    stage0: document.getElementById('stage0'),
    stage1: document.getElementById('stage1'),
    stage2: document.getElementById('stage2'),
    stage3: document.getElementById('stage3'),
    stageLabel: document.getElementById('stageLabel'),
    priorityNote: document.getElementById('priorityNote'),
    wishStage: document.getElementById('wishStage'),
    wishList: document.getElementById('wishList'),
    finalizeWrap: document.getElementById('finalizeWrap'),
    finalizeBtn: document.getElementById('finalizeBtn'),
    finalizeHint: document.getElementById('finalizeHint'),
  };

  /* ========= çŠ¶æ…‹ ========= */
  const state = { room: null, ampm: null, hour: null };

  /* ========= åˆæœŸåŒ– ========= */
  function init(){
    const nm=storage.getName();
    if (nm){ el.displayName.value=nm; el.nameHint.textContent="ä¿å­˜æ¸ˆã¿ï¼ˆä»¥å¾Œå…¥åŠ›ä¸è¦ï¼‰"; }
    el.clearName.onclick=()=>{ storage.clearName(); alert("ã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚ŒãŸæ°åã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"); location.reload(); };

    el.roomChips.innerHTML = `
      <button class="chip" data-room="1">ã‚·ãƒ£ãƒ¯ãƒ¼å®¤ï¼‘ï¼ˆå‘ã‹ã£ã¦å·¦ï¼‰</button>
      <button class="chip" data-room="2">ã‚·ãƒ£ãƒ¯ãƒ¼å®¤ï¼’ï¼ˆå‘ã‹ã£ã¦å³ï¼‰</button>`;
    el.roomChips.querySelectorAll('.chip').forEach(btn=>{
      btn.onclick=()=>{ state.room=btn.dataset.room; state.ampm=null; state.hour=null; updateTrail(); highlightChips(); buildAmPmChips(); clearSlots(); showStage(1); };
    });

    el.saveName.onclick=()=>{
      const v=(el.displayName.value||"").trim();
      if(!v){ alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      storage.setName(v);
      el.nameHint.textContent="ä¿å­˜ã—ã¾ã—ãŸã€‚ä»¥å¾Œã¯è‡ªå‹•ã§åˆ©ç”¨ã§ãã¾ã™ã€‚";
    };

    refreshHeader();
    setInterval(()=>{ refreshHeader(); autoLotteryTick(); }, 10000);

    renderConfirmed();
    renderWishes();
    updateTrail();
    bindFinalize();
    showLotteryPopupIfNeeded();
  }

  function refreshHeader(){
    el.leadLine.textContent = `ãŸã ã„ã¾ã®æ™‚é–“ï¼ˆ${fmtNowHM()}ï¼‰ã¯`;

    const mode=currentMode();
    const tdate=targetDateForMode(mode);
    el.targetDate.textContent = tdate;

    if (endOfDayBlocked()){
      el.nowTag.textContent = "æœ¬æ—¥åˆ†ã®äºˆç´„ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚21æ™‚ä»¥é™ã«æ˜æ—¥ã®åˆ†ã®æŠ½é¸å¸Œæœ›ç™»éŒ²ãŒã§ãã¾ã™ã€‚";
      el.reserveCard.style.display = 'none';
      el.confirmedCard.style.display = 'none';
      return;
    }

    if (mode==="INSTANT_TODAY"){
      el.nowTag.innerHTML = "ç©ºãæ ã®å³æ™‚äºˆç´„ã®æ™‚é–“ã§ã™ã€‚<br>ä»Šã™ãã«äºˆç´„ãŒç¢ºå®šã—ã¾ã™ã€‚";
    }else if (mode==="LOTTERY_FOR_TODAY"){
      el.nowTag.innerHTML = `ã€Œæœ¬æ—¥åˆ†ã€ã®æŠ½é¸å¿œå‹Ÿå—ä»˜æ™‚é–“ã§ã™ï¼ˆç¬¬3å¸Œæœ›ã¾ã§ï¼‰ã€‚<br>8:00ä»¥é™ã«æŠ½é¸çµæœã‚’æœ¬ã‚µã‚¤ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚`;
    }else{
      el.nowTag.innerHTML = `ã€Œç¿Œæ—¥åˆ†ã€ã®æŠ½é¸å¿œå‹Ÿå—ä»˜æ™‚é–“ã§ã™ï¼ˆç¬¬3å¸Œæœ›ã¾ã§ï¼‰ã€‚<br>ç¿Œæœ8:00ä»¥é™ã«æŠ½é¸çµæœã‚’æœ¬ã‚µã‚¤ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚`;
    }

    el.reserveCard.style.display = 'block';
    const showLotteryUI = (mode !== "INSTANT_TODAY");
    el.wishStage.style.display = showLotteryUI ? "block" : "none";
    el.finalizeWrap.style.display = showLotteryUI ? "block" : "none";

    const hasConfirmed = hasConfirmedForTargetDate();
    const blockSelection = (!showLotteryUI) ? false : (hasConfirmed);
    updateSelectionVisibility(blockSelection);

    renderConfirmed();
    renderWishes();
    updateFinalizeUI();
  }

  function hideAllSelectionStages(){ [el.stage0, el.stage1, el.stage2, el.stage3].forEach(n=> n.style.display='none'); }
  function hasConfirmedForTargetDate(){
    const uid=storage.getUID();
    const tdate=targetDateForMode(currentMode());
    const items=Object.values(storage.getRes()).filter(r=> r.userId===uid && r.date===tdate);
    return items.length>0;
  }
  function updateSelectionVisibility(block){
    if (block){
      el.blockedNote.style.display='block';
      el.blockedNote.textContent = 'ç¾åœ¨ã€ã“ã®æ—¥ã®äºˆç´„ã¯ç¢ºå®šã—ã¦ã„ã¾ã™ã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯ä¸Šéƒ¨ã®ã€Œäºˆç´„å–ã‚Šæ¶ˆã—ã€ã‚’è¡Œã„ã€å†åº¦ãŠé¸ã³ãã ã•ã„ã€‚';
      hideAllSelectionStages();
    }else{
      el.blockedNote.style.display='none';
      el.stage0.style.display='block';
      el.stage1.style.display = state.room ? 'block':'none';
      el.stage2.style.display = (state.room && state.ampm) ? 'block':'none';
      el.stage3.style.display = (state.room && state.ampm && state.hour!=null) ? 'block':'none';
    }
  }

  function showStage(idx){
    el.stage0.style.display = (idx>=0)?"block":"none";
    el.stage1.style.display = (idx>=1)?"block":"none";
    el.stage2.style.display = (idx>=2)?"block":"none";
    el.stage3.style.display = (idx>=3)?"block":"none";
  }
  function updateTrail(){
    const parts=[];
    if(state.room) parts.push(`ã‚·ãƒ£ãƒ¯ãƒ¼å®¤${state.room}`);
    if(state.ampm) parts.push(state.ampm==="am"?"åˆå‰":"åˆå¾Œ");
    if(state.hour!=null) parts.push(`${String(state.hour).padStart(2,'0')}:00å°`);
    el.selectionTrail.textContent = parts.length? parts.join(" / ") : "â€”";
  }
  function highlightChips(){
    el.roomChips.querySelectorAll('.chip').forEach(b=> b.classList.toggle('active', b.dataset.room===state.room));
    el.amPmChips.querySelectorAll('.chip').forEach(b=> b.classList.toggle('active', b.dataset.ampm===state.ampm));
  }
  function clearSlots(){ el.stageLabel.textContent=""; el.priorityNote.style.display="none"; el.slots.innerHTML=""; }

  function buildAmPmChips(){
    const mode=currentMode();
    const tdate=targetDateForMode(mode);
    const todayISO = toISODate(nowTZ());
    const nowHM = fmtNowHM();
    const showAM = !(tdate===todayISO && nowHM>="13:00");
    const amBtn = showAM ? `<button class="chip" data-ampm="am">åˆå‰ï¼ˆ9:00â€“12:59ï¼‰</button>` : "";
    const pmBtn = `<button class="chip" data-ampm="pm">åˆå¾Œï¼ˆ13:00â€“21:00ï¼‰</button>`;
    el.amPmChips.innerHTML = amBtn + pmBtn;
    el.amPmChips.querySelectorAll('.chip').forEach(btn=>{
      btn.onclick=()=>{ state.ampm=btn.dataset.ampm; state.hour=null; updateTrail(); highlightChips(); buildHourChips(); clearSlots(); showStage(2); };
    });
  }
  function inPriorityHour(room, hour, dateISO){
    if(!isWeekday(dateISO)) return false;
    const p=CONFIG.priority[room]; if(!p) return false;
    const {h:phs}=parseHM(p.start); const {h:phe, m:phem}=parseHM(p.end);
    return (hour>=phs) && (hour < phe || (hour===phe && phem>0));
  }
  function isPrioritySlot(s){
    if(!isWeekday(s.date)) return false;
    const p=CONFIG.priority[s.room]; if(!p) return false;
    return s.start >= p.start && s.start < p.end;
  }
  function buildHourChips(){
    const mode=currentMode();
    const tdate=targetDateForMode(mode);
    const listRaw = (state.ampm==="am") ? [9,10,11,12] : [13,14,15,16,17,18,19,20];
    const todayISO = toISODate(nowTZ());
    const nowHM = fmtNowHM();
    const list = (tdate === todayISO)
      ? listRaw.filter(h => `${z2(h+1)}:00` > nowHM)
      : listRaw;
    el.hourChips.innerHTML = list.map(h=>{
      const pri = state.room ? inPriorityHour(state.room, h, tdate) : false;
      const cls = `chip ${state.hour===h?'active':''} ${pri?'priority':''}`;
      const label = `${z2(h)}:00`;
      return `<button class="${cls}" data-hour="${h}">${label}${pri?'<span class="subtxt">â€»ãŠé ã‹ã‚Šå„ªå…ˆæ ï¼ˆå¹³æ—¥ã®ã¿ï¼‰</span>':''}</button>`;
    }).join('');
    el.hourChips.querySelectorAll('.chip').forEach(btn=>{
      btn.onclick=()=>{ state.hour=Number(btn.dataset.hour); updateTrail(); buildSlots(); showStage(3); highlightChips(); };
    });
  }

  function generateSlotsForDateRoom(dateISO, room){
    const slots=[];
    const {h:sh,m:sm}=parseHM(CONFIG.slotStart);
    const {h:eh,m:em}=parseHM(CONFIG.slotEnd);
    let s=new Date(`${dateISO}T00:00:00+09:00`); s.setHours(sh,sm,0,0);
    const end=new Date(`${dateISO}T00:00:00+09:00`); end.setHours(eh,em,0,0);
    while(s<end){
      const start=`${z2(s.getHours())}:${z2(s.getMinutes())}`;
      const e=addMinutes(s,CONFIG.slotMinutes);
      const endtxt=`${z2(e.getHours())}:${z2(e.getMinutes())}`;
      slots.push({id:`${dateISO}_${room}_${start}`,date:dateISO,room,start,end:endtxt});
      s=e;
    }
    return slots;
  }
  function buildSlots(){
    const mode=currentMode(); const tdate=targetDateForMode(mode);
    if(!state.room || state.hour==null){ clearSlots(); return; }
    if (endOfDayBlocked()){ clearSlots(); return; }

    const all = generateSlotsForDateRoom(tdate, state.room);
    const hourStart = `${z2(state.hour)}:00`;
    const hourEnd   = `${z2(state.hour+1)}:00`;
    let slots = all.filter(s=> s.start>=hourStart && s.start<hourEnd);

    const res=storage.getRes();
    const priHour = inPriorityHour(state.room, state.hour, tdate);
    el.stageLabel.textContent = `å¯¾è±¡æ—¥ ${tdate} / ${hourStart}å°`;
    el.priorityNote.style.display = priHour ? "block":"none";

    el.slots.innerHTML = "";
    const myChoices = getMyChoicesForDate(tdate);
    const nowHM = fmtNowHM();
    const todayISO = toISODate(nowTZ());
    const uid = storage.getUID();

    const myTodayReservation = Object.values(res).find(r=> r.userId===uid && r.date===tdate);

    for(const s of slots){
      if (tdate === todayISO && s.start <= nowHM) continue;
      const booked = !!res[s.id];
      if ((mode==="LOTTERY_FOR_TODAY" || mode==="LOTTERY_FOR_TOMORROW") && booked) continue;

      const div = document.createElement('div');
      const inPri = isPrioritySlot(s);
      const selectedIdx = myChoices.indexOf(s.id);
      div.className = `slot ${booked?'booked':'open'} ${inPri?'priority':''} ${selectedIdx>=0?'selected':''}`;
      div.innerHTML = `
        <div class="time">${s.start}â€“${s.end}${inPri?'<span class="prioMark"></span>':''}</div>
        <div class="actions"></div>
        <div class="status">${
          (mode==="INSTANT_TODAY" && !booked)?'<span class="badge" style="border-color:#bbf7d0;background:#f0fdf4;color:#166534">ç©ºã</span>':''}${
          (mode==="INSTANT_TODAY" && booked)?'<span class="badge">åŸ‹ã¾ã‚Š</span>':''}
        </div>
      `;
      const act = div.querySelector('.actions');
      if(!booked){
        if(mode==="INSTANT_TODAY"){
          const b=document.createElement('button'); b.className="btn success";
          b.textContent = myTodayReservation ? "äºˆç´„ã‚’å¤‰æ›´ã™ã‚‹" : "äºˆç´„ã™ã‚‹";
          b.onclick=()=> tryReserveInstant(s, inPri, myTodayReservation ? myTodayReservation.id : null);
          act.appendChild(b);
        }else{
          if(selectedIdx>=0){
            const tag=document.createElement('span'); tag.className="badge"; tag.style.cssText="border-color:#bae6fd;background:#f0f9ff;color:#075985";
            tag.textContent=`ç¬¬${selectedIdx+1}`;
            const rm=document.createElement('button'); rm.className="btn ghost"; rm.textContent="å¤–ã™";
            rm.onclick=()=>{ removeChoice(tdate, s.id); buildSlots(); renderWishes(); updateFinalizeUI(); };
            act.append(tag, rm);
          }else{
            const cur=myChoices.slice();
            if(cur.length<3){
              const add=document.createElement('button'); add.className="btn primary"; add.textContent=`ç¬¬${cur.length+1}ã«è¿½åŠ `;
              add.onclick=()=>{ tryAddChoice(tdate, s, inPri); renderWishes(); updateFinalizeUI(); };
              act.appendChild(add);
            }else{
              const full=document.createElement('span'); full.className="note"; full.textContent="â€»å¸Œæœ›ã¯3æ ã¾ã§";
              act.appendChild(full);
            }
          }
        }
      }
      el.slots.appendChild(div);
    }
  }

  function requireName(){ const name=(el.displayName.value||"").trim(); if(!name){ alert("æ°åã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚"); return null; } return name; }
  function confirmPriorityIfNeeded(isPri){ if(!isPri) return true; return confirm("ã“ã®æ™‚é–“ã¯ä¿è‚²å£«ã®ä»˜ãæ·»ã„ãŒå¿…è¦ãªæ–¹ã®å„ªå…ˆæ ã§ã™ã€‚äºˆç´„ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ"); }

  function tryReserveInstant(slot, isPri, replaceFromId=null){
    if (endOfDayBlocked()){ alert("æœ¬æ—¥åˆ†ã®äºˆç´„ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚"); return; }
    const name=requireName(); if(!name) return;
    if(!confirmPriorityIfNeeded(isPri)) return;

    const uid=storage.getUID();
    const today=toISODate(nowTZ());
    if(slot.date!==today){ alert("å½“æ—¥åˆ†ã®ã¿äºˆç´„ã§ãã¾ã™ï¼ˆ8:00â€“21:00ï¼‰ã€‚"); return; }

    const res=storage.getRes();
    const already = Object.values(res).some(r=> r.date===today && r.userId===uid);
    if(already && !replaceFromId){ alert("ã™ã§ã«ç¢ºå®šæ ãŒã‚ã‚Šã¾ã™ã€‚åˆ¥æ ã«å¤‰æ›´ã™ã‚‹å ´åˆã¯ç©ºãæ ã®ã€Œäºˆç´„ã‚’å¤‰æ›´ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚"); return; }
    if(res[slot.id]){ alert("å…ˆã«åŸ‹ã¾ã‚Šã¾ã—ãŸã€‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚"); buildSlots(); return; }

    if (replaceFromId && res[replaceFromId]) { delete res[replaceFromId]; }

    res[slot.id]={userId:uid,name,...slot,source:"instant"};
    storage.setRes(res);
    alert(replaceFromId ? "äºˆç´„ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚" : "äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸã€‚");
    buildSlots(); renderConfirmed(); refreshHeader();
  }

  function getMyChoicesForDate(targetDate){
    const lot=storage.getLot(); const uid=storage.getUID();
    const list=lot[targetDate]||[]; const mine=list.find(x=> x.userId===uid);
    return mine? (mine.choices||[]) : [];
  }
  function setMyChoicesForDate(targetDate, choices){
    const now = nowTZ();
    const today = toISODate(now);
    const closeKey = "sr_lottery_closed_"+targetDate;
    const uid = storage.getUID();
    setConfirmed(uid, targetDate, false);
    if (targetDate === today) {
      if (now.getHours() >= 8 || localStorage.getItem(closeKey)) {
        alert("æœ¬æ—¥åˆ†ã®æŠ½é¸å—ä»˜ã¯ 8:00 ã§çµ‚äº†ã—ã¾ã—ãŸã€‚");
        return false;
      }
    }
    const tomorrow = toISODate(new Date(now.getTime()+24*60*60*1000));
    if (targetDate === tomorrow && now.getHours() < 21) {
      alert("ç¿Œæ—¥åˆ†ã®æŠ½é¸å—ä»˜ã¯ 21:00 ã‹ã‚‰ã§ã™ã€‚");
      return false;
    }
    const lot=storage.getLot();
    let list=lot[targetDate]||[]; let mine=list.find(x=> x.userId===uid);
    const name=requireName(); if(!name) return false;
    if(!mine){ mine={userId:uid,name,choices:[]}; list.push(mine); }
    mine.name=name; mine.choices=choices.slice(0,3);
    lot[targetDate]=list; storage.setLot(lot);
    const part=storage.getPart(); const arr=new Set(part[targetDate]||[]); arr.add(uid); part[targetDate]=Array.from(arr); storage.setPart(part);
    markWishItemsConfirmed(false);
    return true;
  }
  function tryAddChoice(targetDate, slot, isPri){
    const name=requireName(); if(!name) return;
    if(!confirmPriorityIfNeeded(isPri)) return;
    const cur=getMyChoicesForDate(targetDate);
    if(cur.includes(slot.id)) return;
    if(cur.length>=3){ alert("ç¬¬1ã€œç¬¬3ã¾ã§ã§ã™ã€‚"); return; }
    const next = cur.concat([slot.id]);
    const ok=setMyChoicesForDate(targetDate, next);
    if(ok){
      if (next.length === 3){
        alert('å®Œäº†ã—ãŸã‚‰ã€æœ€ä¸‹éƒ¨ã«ã‚ã‚‹ã€ŒæŠ½é¸å¸Œæœ›ã‚’ç¢ºå®šã™ã‚‹ã€ã‚’æŠ¼ã—ã¦å¸Œæœ›ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
      } else {
        alert("å¸Œæœ›æ ã«è¿½åŠ ã—ã¾ã—ãŸã€‚");
      }
      buildSlots(); updateFinalizeUI();
    }
  }
  function removeChoice(targetDate, slotId){
    const cur=getMyChoicesForDate(targetDate);
    const ok=setMyChoicesForDate(targetDate, cur.filter(x=> x!==slotId));
    renderWishes(); updateFinalizeUI();
  }

  function weekRangeISO(targetISO){
    const d=new Date(`${targetISO}T00:00:00+09:00`);
    const wd=d.getDay(); const diffToMon = (wd===0? -6 : 1-wd);
    const start=new Date(d); start.setDate(d.getDate()+diffToMon);
    const end=new Date(start); end.setDate(start.getDate()+6);
    const toISO=(dt)=>`${dt.getFullYear()}-${z2(dt.getMonth()+1)}-${z2(dt.getDate())}`;
    return {start:toISO(start), end:toISO(end)};
  }
  function winsThisWeek(userId, weekStartISO, weekEndISO){
    const res=storage.getRes();
    return Object.values(res).filter(r=> r.userId===userId && r.date>=weekStartISO && r.date<=weekEndISO && r.source==="lottery").length;
  }
  function runLotteryForDate(targetISO){
    const lot=storage.getLot(); const entries=(lot[targetISO]||[]).map(x=>({...x}));
    if(entries.length===0) return {assigned:0};
    const res=storage.getRes();
    const byUserWins={};
    for(const r of Object.values(res)){ if(r.date===targetISO) byUserWins[r.userId]=(byUserWins[r.userId]||0)+1; }
    const {start:weekStart,end:weekEnd}=weekRangeISO(targetISO);
    const slotApplicants={};
    for(const e of entries){
      (e.choices||[]).slice(0,3).forEach((slotId,idx)=>{
        (slotApplicants[slotId] ||= []).push({userId:e.userId,name:e.name,p:idx});
      });
    }
    function weight(app){
      const base = app.p===0?1.0 : app.p===1?0.6 : 0.3;
      const wwins = winsThisWeek(app.userId, weekStart, weekEnd);
      const fairness = Math.max(0.1, (wwins===0?0.5: wwins===1?0.2: wwins===2?0.0: -0.2));
      return Math.max(0.05, base + fairness);
    }
    function pickWeighted(arr){ const tot=arr.reduce((a,b)=>a+weight(b),0); let r=Math.random()*tot; for(const x of arr){ r-=weight(x); if(r<=0) return x; } return arr[arr.length-1]; }
    const allSlots = CONFIG.rooms.flatMap(room => generateSlotsForDateRoom(targetISO, room));
    let assigned=0;
    for(const s of allSlots){
      if(res[s.id]) continue;
      const apps=(slotApplicants[s.id]||[]).filter(a=> !byUserWins[a.userId]);
      if(apps.length===0) continue;
      const win=pickWeighted(apps);
      res[s.id]={userId:win.userId,name:win.name,...s,source:"lottery"};
      byUserWins[win.userId]=1;
      assigned++;
    }
    delete lot[targetISO];
    storage.setRes(res); storage.setLot(lot);
    return {assigned};
  }

  function autoLotteryTick(){
    const n = nowTZ();
    const h = n.getHours(), m = n.getMinutes();
    const today = toISODate(n);
    const closeKey = "sr_lottery_closed_"+today;
    const doneKey  = "sr_lottery_done_"+today;
    if (h === 8 && !localStorage.getItem(closeKey)) localStorage.setItem(closeKey, "1");
    if (h === 8 && m < 5 && !localStorage.getItem(doneKey)) {
      runLotteryForDate(today);
      localStorage.setItem(doneKey, "1");
    }
  }
  function showLotteryPopupIfNeeded(){
    const n=nowTZ();
    if (n.getHours() < 8) return;
    const today = toISODate(n);
    const flagKey = "sr_popup_done_" + today;
    if (localStorage.getItem(flagKey)) return;
    const uid = storage.getUID();
    const part = storage.getPart();
    const participants = new Set(part[today] || []);
    if(!participants.has(uid)) return;
    const wins = Object.values(storage.getRes()).filter(x => x.date === today && x.userId === uid && x.source === "lottery");
    if (wins.length > 0) {
      let msg = "ã€æŠ½é¸çµæœã€‘\n";
      wins.forEach(w => msg += `ãƒ»ã‚·ãƒ£ãƒ¯ãƒ¼å®¤${w.room} ${w.start}ã€œ${w.end}\n`);
      msg += "\nä¸Šè¨˜ã®æ™‚é–“å¸¯ã§äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸã€‚";
      alert(msg);
    } else {
      alert("ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä»Šå›ã®æŠ½é¸ã§ã¯ã”å¸Œæœ›ã®æ™‚é–“å¸¯ãŒç¢ºä¿ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nç¾åœ¨ã¯ç©ºã„ã¦ã„ã‚‹æ ã‚’å³æ™‚ã”äºˆç´„ã„ãŸã ã‘ã¾ã™ã®ã§ã€ã”éƒ½åˆã®è‰¯ã„æ™‚é–“ã‚’ãŠé¸ã³ãã ã•ã„ã€‚");
    }
    localStorage.setItem(flagKey, "1");
    renderConfirmed();
  }

  function renderConfirmed(){
    if (endOfDayBlocked()){ el.confirmedCard.style.display='none'; return; }
    const uid=storage.getUID();
    const tdate=targetDateForMode(currentMode());
    const items=Object.values(storage.getRes()).filter(r=> r.userId===uid && r.date===tdate)
                   .sort((a,b)=> (a.start).localeCompare(b.start));
    const card=el.confirmedCard, list=el.confirmedList;
    if(items.length===0){ card.style.display="none"; list.innerHTML=""; return; }
    card.style.display="block"; list.innerHTML="";
    const mode=currentMode();
    for(const r of items){
      const div=document.createElement('div'); div.className="item";
      const leftHTML = `
        <span class="badge" style="border-color:${r.source==='instant'?'#bbf7d0':'#bae6fd'};background:${r.source==='instant'?'#f0fdf4':'#f0f9ff'};color:${r.source==='instant'?'#166534':'#075985'}">${r.source==='instant'?'å³æ™‚':'æŠ½é¸'}</span>
        <span class="timeinfo">${r.date} ã‚·ãƒ£ãƒ¯ãƒ¼å®¤${r.room} ${r.start}â€“${r.end}</span>
      `;
      const btnWrap = document.createElement('div');
      btnWrap.style.marginLeft = "auto";
      btnWrap.style.display = "flex";
      btnWrap.style.gap = "8px";
      btnWrap.innerHTML = `<button class="btn" data-act="cancel" data-id="${r.id}">äºˆç´„å–ã‚Šæ¶ˆã—</button>`;
      div.innerHTML = leftHTML;
      div.appendChild(btnWrap);
      list.appendChild(div);
    }
    list.querySelectorAll('button[data-act="cancel"]').forEach(b=>{ b.onclick = ()=> cancelReservation(b.dataset.id); });
  }
  function cancelReservation(slotId){
    const res = storage.getRes();
    if (!res[slotId]) { alert("æ—¢ã«å–ã‚Šæ¶ˆã•ã‚Œã¦ã„ã¾ã™ã€‚"); renderConfirmed(); return; }
    if (!confirm("ã“ã®äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    delete res[slotId];
    storage.setRes(res);
    renderConfirmed();
    refreshHeader();
    alert("äºˆç´„ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚");
  }

  function renderWishes(){
    const mode=currentMode();
    const tdate=targetDateForMode(mode);
    if (mode === "INSTANT_TODAY"){ el.wishList.innerHTML=''; return; }
    const choices=getMyChoicesForDate(tdate);
    const labels=["ç¬¬ï¼‘","ç¬¬ï¼’","ç¬¬ï¼“"];
    el.wishList.innerHTML="";
    if(choices.length===0){
      el.wishList.innerHTML='<div class="note">ç¾åœ¨ã€å¸Œæœ›ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæŠ½é¸å—ä»˜æ™‚é–“ã«æœ€å¤§3ã¤ã¾ã§è¿½åŠ ã§ãã¾ã™ï¼‰ã€‚</div>';
    } else {
      for(let i=0;i<3;i++){
        const id=choices[i];
        const row=document.createElement('div'); row.className="item"; row.dataset.index=i;
        if(!id){
          row.innerHTML = `<span class="handle">â˜°</span><span class="rank">${labels[i]}</span><div class="label"><div class="date">æœªé¸æŠ</div></div><div class="fill"></div><button class="btn ghost rm" disabled>å¤–ã™</button>`;
        }else{
          const [dateISO, room, start]=id.split("_");
          const end=addMinutes(new Date(`${dateISO}T${start}:00+09:00`), CONFIG.slotMinutes);
          const endtxt=`${z2(end.getHours())}:${z2(end.getMinutes())}`;
          row.dataset.slotId = id;
          row.innerHTML = `<span class="handle">â˜°</span><span class="rank">${labels[i]}</span><div class="label"><div class="date">${dateISO}</div><div class="timeinfo">ã‚·ãƒ£ãƒ¯ãƒ¼å®¤${room}ã€€${start}â€“${endtxt}</div></div><div class="fill"></div><button class="btn ghost rm" data-id="${id}">å¤–ã™</button>`;
        }
        el.wishList.appendChild(row);
      }
    }
    const uid=storage.getUID(); const conf=isConfirmed(uid,tdate);
    markWishItemsConfirmed(conf);
    el.wishList.querySelectorAll('.rm[data-id]').forEach(btn=>{ btn.onclick=()=>{ removeChoice(targetDateForMode(currentMode()), btn.dataset.id); }; });
    bindWishReorder();
  }
  function markWishItemsConfirmed(flag){
    el.wishList.querySelectorAll('.item').forEach(n=>{ if(flag) n.classList.add('confirmed'); else n.classList.remove('confirmed'); });
  }

  function bindFinalize(){
    el.finalizeBtn.onclick = () => {
      const uid = storage.getUID();
      const tdate = targetDateForMode(currentMode());
      const choices = getMyChoicesForDate(tdate);
      if (choices.length < 3) { alert("ç¬¬ï¼‘ã€œç¬¬ï¼“ã¾ã§é¸ã‚“ã§ã‹ã‚‰ç¢ºå®šã—ã¦ãã ã•ã„ã€‚"); return; }
      setConfirmed(uid, tdate, true);
      updateFinalizeUI();
      markWishItemsConfirmed(true);
      alert("ç¢ºå®šã•ã‚Œã¾ã—ãŸã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚çµæœã¯8æ™‚ã«æœ¬ç”»é¢ã§ç™ºè¡¨ã•ã‚Œã¾ã™ã€‚");
    };
  }
  function updateFinalizeUI(){
    const uid = storage.getUID();
    const tdate = targetDateForMode(currentMode());
    const choices = getMyChoicesForDate(tdate);
    const confirmed = isConfirmed(uid, tdate);
    const canConfirm = choices.length === 3;
    el.finalizeBtn.disabled = !canConfirm || confirmed;
    el.finalizeBtn.style.opacity = (el.finalizeBtn.disabled ? "0.6" : "1");
    if (!canConfirm) el.finalizeHint.textContent = "ç¬¬ï¼‘ã€œç¬¬ï¼“ã¾ã§é¸ã¶ã¨ç¢ºå®šã§ãã¾ã™ã€‚";
    else if (confirmed) el.finalizeHint.textContent = "ç¢ºå®šæ¸ˆã¿ã§ã™ã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯å†åº¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚";
    else el.finalizeHint.textContent = "é€ä¿¡ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚";
  }

  function bindWishReorder(){
    const list = el.wishList;
    const LONG_MS = 300;
    let pressTimer=null, draggingEl=null, placeholder=null, startY=0;
    const rows = Array.from(list.querySelectorAll('.item')).filter(r=> r.dataset.slotId);
    rows.forEach(row=>{
      row.addEventListener('pointerdown', (e)=>{
        if(e.button!==0) return;
        if (e.target.closest('.rm')) return;
        startY = e.clientY;
        pressTimer = setTimeout(()=> startDrag(row, e.clientY), LONG_MS);
        row.setPointerCapture(e.pointerId);
      });
      row.addEventListener('pointermove', (e)=>{
        if(!pressTimer && !draggingEl) return;
        if(pressTimer && Math.abs(e.clientY - startY) > 6){ clearTimeout(pressTimer); pressTimer=null; }
        if(draggingEl){
          e.preventDefault();
          draggingEl.style.transform = `translateY(${e.clientY - startY}px)`;
          movePlaceholder(e.clientY);
        }
      });
      row.addEventListener('pointerup', ()=>{ clearTimeout(pressTimer); pressTimer=null; if(draggingEl){ endDrag(); } });
      row.addEventListener('pointercancel', ()=>{ clearTimeout(pressTimer); pressTimer=null; if(draggingEl){ endDrag(); } });
    });
    function startDrag(row, y){
      draggingEl = row; row.classList.add('dragging');
      placeholder = document.createElement('div'); placeholder.className = 'placeholder';
      placeholder.style.height = `${row.getBoundingClientRect().height}px`; row.after(placeholder); startY = y;
    }
    function movePlaceholder(clientY){
      const siblings = Array.from(list.querySelectorAll('.item,.placeholder')).filter(n=> n!==draggingEl);
      let insertBefore = null;
      for(const el of siblings){
        const rect = el.getBoundingClientRect();
        if(clientY < rect.top + rect.height/2){ insertBefore = el; break; }
      }
      if(insertBefore){ list.insertBefore(placeholder, insertBefore); } else { list.appendChild(placeholder); }
    }
    function endDrag(){
      draggingEl.classList.remove('dragging'); draggingEl.style.transform = '';
      placeholder.replaceWith(draggingEl); placeholder=null;
      const tdate=targetDateForMode(currentMode());
      const ids = Array.from(list.querySelectorAll('.item')).map(r=> r.dataset.slotId || null).filter(x=> x!==undefined);
      const newChoices = ids.filter(Boolean);
      setMyChoicesForDate(tdate, newChoices);
      draggingEl=null; renderWishes(); updateFinalizeUI();
    }
  }

  function initSWOnce(){
    // â˜… æ–°SWåï¼‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãç™»éŒ²ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ network-first ã§é…ä¿¡ã™ã‚‹å®Ÿè£…å‰æï¼‰
    const BUILD = 'admin-2025-11-04-4';
    if (!('serviceWorker' in navigator)) return;
    navigator.serviceWorker.register('/shower-pwa/sw-admin-v4.js?ver='+BUILD)
      .then(reg => { if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'}); })
      .catch(console.error);
  }

  function initAll(){
    init();
    initSWOnce(); // â˜… æ—§ './sw.js' ã®ç™»éŒ²ã¯ã‚„ã‚ã‚‹ï¼ˆæ··ç·šã®å…ƒï¼‰
  }

  initAll();
  </script>
</body>
</html>
