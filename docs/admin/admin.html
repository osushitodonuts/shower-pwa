<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ★ 1つ上の階層を参照（adminフォルダの中なので） -->
  <link rel="manifest" href="../manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <link rel="apple-touch-icon" href="../newicons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="../newicons/icon-180.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>シャワー室 予約管理（管理者）</title>

  <style>
  /* ここはあなたのCSSそのまま、改変なしでOK */
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --primary:#1d4ed8; --ok:#16a34a; --danger:#dc2626;
    --panel:#f0f9ff; --radius:14px; --space:16px;
    --shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06);
    --panel-br:#bae6fd; --priority:#f9a8d4;
    --g1:#e0f2fe; --g2:#fde7f3; --row-priority:#fef9c3;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  /* （中略：あなたのCSSをそのまま残す） */
  </style>
</head>

<body>
  <!-- あなたのHTML本体部分をそのまま残す -->
  <!-- header, container, dialogなどは全部このままでOK -->

<script>
/********************************************************
 * ★ adminアクセス制御ブロックを追加（←これがindex版のポイント）
 ********************************************************/
const ADMIN_ACCESS_KEY = "kagoshimauniv_peds"; // ←管理者だけに配るキー（好きに変更OK）

const params = new URLSearchParams(location.search);
const key = params.get("key");
const ADMIN_KEYS = { SETTINGS:'sr_admin_settings', DEVICE:'sr_admin_device_id' };

function getDeviceId(){
  let v=localStorage.getItem(ADMIN_KEYS.DEVICE);
  if(!v){ v = `dev-${crypto.randomUUID()}`; localStorage.setItem(ADMIN_KEYS.DEVICE,v); }
  return v;
}

function registerDevice(){
  const s = JSON.parse(localStorage.getItem(ADMIN_KEYS.SETTINGS) || "{}");
  s.allowedDevices ||= [];
  const id = getDeviceId();
  if(!s.allowedDevices.includes(id)){
    s.allowedDevices.push(id);
    localStorage.setItem(ADMIN_KEYS.SETTINGS, JSON.stringify(s));
    alert("この端末を管理者端末として登録しました。");
  }
}

if(key === ADMIN_ACCESS_KEY){
  registerDevice();
  // ?key を消して再読み込み
  location.href = location.origin + location.pathname;
} else {
  const s = JSON.parse(localStorage.getItem(ADMIN_KEYS.SETTINGS) || "{}");
  const allowed = s.allowedDevices || [];
  const id = getDeviceId();
  if(!allowed.includes(id)){
    document.body.innerHTML = `
      <div style="padding:50px;text-align:center">
        <h2>アクセス権がありません</h2>
        <p>管理者専用URLからアクセスしてください。</p>
      </div>`;
    throw new Error("Unauthorized device");
  }
}

/********************************************************
 * 以降はあなたの既存JSをそのまま配置
 ********************************************************/
/**************** PC時間 or ?mock=YYYY-MM-DDTHH:MM:SS ****************/
const qs = new URLSearchParams(location.search);
const MOCK = qs.get('mock');
const nowLocal = ()=> MOCK ? new Date(MOCK.replace(' ', 'T')) : new Date();

/* （中略：あなたのJSコードはそのまま残す） */

/* ★ Service Worker のパスだけ変更 */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('../sw.js').catch(console.error);
}
</script>
</body>
</html>
