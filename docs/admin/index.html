<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ルート絶対パスで統一 -->
  <link rel="manifest" href="/shower-pwa/manifest.webmanifest">
  <meta name="theme-color" content="#1e40af">
  <link rel="apple-touch-icon" href="/shower-pwa/newicons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/shower-pwa/newicons/icon-180.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>シャワー室 予約管理（管理者）</title>

  <style>
  :root{
    --bg:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --primary:#1d4ed8; --ok:#16a34a; --danger:#dc2626;
    --panel:#f0f9ff; --radius:14px; --space:16px;
    --shadow:0 1px 2px rgba(15,23,42,.06), 0 8px 24px rgba(15,23,42,.06);
    --panel-br:#bae6fd; --priority:#f9a8d4; /* legacy var (未使用に近い) */
    --g1:#e0f2fe; --g2:#fde7f3; --row-priority:#fef9c3; /* 表（抽選）用の薄黄 */
    --priority-slot:#fffbe6; /* カードの優先枠：さらに薄い黄 */
    --fs-body: clamp(13px, 2.9vw, 15px);
    --fs-small: clamp(11px, 2.6vw, 13px);
    --fs-tiny: clamp(10px, 2.3vw, 12px);
    --pad-card: 10px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:var(--fs-body)}
  .container{max-width:1100px;margin:0 auto;padding:18px}
  header{border-bottom:1px solid var(--line);background:#fff}
  header .inner{max-width:1100px;margin:0 auto;padding:12px var(--space);display:flex;gap:12px;align-items:center;justify-content:space-between}

  /* タイトルは必ず1行に収める（省略記号） */
  .h1{font-weight:900;font-size:clamp(18px,4.2vw,24px);display:flex;align-items:center;gap:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  small.muted{color:var(--muted)}

  /* ヘッダ内の3ブロック */
  .left{display:flex;flex-direction:column;gap:6px;min-width:0}
  .meta{display:grid;grid-template-columns:1fr;gap:6px;align-items:center}
  .right{display:flex;gap:8px;align-items:center}

  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px dashed var(--line);border-radius:999px;background:#f8fafc;white-space:nowrap;min-width:0;font-size:var(--fs-small)}
  input,select,button{border:1px solid var(--line);border-radius:10px;padding:10px 12px;min-height:40px;font-size:var(--fs-body)}
  button{background:#fff;cursor:pointer}
  button.primary{background:#2563eb;border-color:#1d4ed8;color:#fff}
  button.danger{background:#ef4444;border-color:#dc2626;color:#fff}
  button.ghost{background:#fff;border-color:#d1d5db}
  button.icon{display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:10px}
  .note{font-size:var(--fs-small);color:var(--muted)}

  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin:16px 0}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:clamp(16px,3.8vw,18px)}
  .section{padding:12px;display:grid;gap:10px}

  /* 2列（室1/室2） */
  .grid-rooms-wrap{position:relative; width:100%; overflow:hidden; /* スケールで高さを確保するため明示 */}
  .grid-rooms{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px; transform-origin:top left; will-change:transform;}
  .room-col{border:1px solid var(--panel-br);border-radius:12px;background:var(--panel);padding:10px;min-width:0}
  .room-col.room2{background:var(--g2); border-color:#fbcfe8;}
  .room-title{font-weight:800;margin:0 0 8px 0;font-size:clamp(14px,3.4vw,16px)}
  .list{display:grid;grid-template-columns:1fr;gap:8px;min-width:0}

  /* スロットを3段構成に（よりコンパクト） */
  .slot{border:1px solid var(--line);border-radius:12px;background:#ffffff;padding:var(--pad-card);display:flex;flex-direction:column;gap:8px;font-size:var(--fs-small);min-width:0}
  .slot.priority{border:1px solid var(--line) !important; background:var(--priority-slot) !important; box-shadow:none !important;}
  .slot .row1{display:flex;align-items:center;justify-content:space-between;gap:8px;white-space:nowrap;min-width:0}
  .slot .row1 .time{font-weight:700;font-size:var(--fs-body)}
  .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #cbd5e1;border-radius:999px;padding:3px 8px;font-size:var(--fs-tiny);white-space:nowrap}
  .badge.ok{background:#f0fdf4;border-color:#bbf7d0;color:#166534}
  .badge.info{background:#f0f9ff;border-color:#bae6fd;color:#075985}
  .slot .row2{min-height:1em;min-width:0}
  .slot .row3{display:flex;gap:6px;justify-content:flex-end;flex-wrap:nowrap;min-width:0}
  .slot .row3 button{padding:6px 8px;min-height:34px;font-size:var(--fs-small)}

  /* 抽選表 */
  .table-wrap{overflow:auto}
  .table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:middle}
  .table thead th{position:sticky;top:0;background:#fff;z-index:1}
  th.center, td.center{text-align:center}
  th.left, td.left{text-align:left}
  .col-time{width:140px}
  .timecode{font-variant-numeric:tabular-nums}
  td.g1, th.g1{background:var(--g1)}
  td.g2, th.g2{background:var(--g2)}
  .vcut-thick{border-left:3px solid #9ca3af}
  .vcut-thin{border-left:1px solid #d1d5db}
  .table tbody tr:nth-child(odd) td{background:rgba(15,23,42,0.015)}
  .table tbody tr:hover td{background:rgba(59,130,246,0.06)}
  tr.priorityRow td{background:var(--row-priority) !important}

  /* スマホ最適化：横スクロールなしで室1/2を収める */
  @media (max-width:640px){
    .container{padding:12px}
    header .inner{flex-direction:column;align-items:stretch;gap:10px}
    .right{flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch}
    .right>*{flex:0 0 auto}
    .meta{grid-template-columns:1fr;gap:6px}
    .grid-rooms{gap:8px}
    .room-col{padding:8px}
    .list{gap:6px}
    .slot{padding:8px}
    input,select,button{min-height:36px;padding:8px 10px}
    /* カード枠を必ず画面幅に収める */
    .card{border-width:1px;}
  }
    header .inner{flex-direction:column;align-items:stretch;gap:10px}
    .right{flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch}
    .right>*{flex:0 0 auto}
    .meta{grid-template-columns:1fr;gap:6px}
    .grid-rooms{gap:8px}
    .room-col{padding:8px}
    .list{gap:6px}
    .slot{padding:8px}
    input,select,button{min-height:36px;padding:8px 10px}
  }

  /* さらに狭い端末（~380px）で絶対に切らさない最小化 */
  @media (max-width:400px){
    :root{ --fs-body: 13px; --fs-small: 12px; --fs-tiny: 11px; --pad-card: 6px; }
    .grid-rooms{gap:6px}
    .room-title{margin-bottom:6px}
    .slot .row3 button{padding:5px 6px;min-height:30px}
    .pill{padding:4px 8px}
  }

  /* ======== 共通モーダル（設定/編集/ログインで使用）======== */
  .dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom)}
  .dialog::before{content:"";position:absolute;inset:0;background:rgba(15,23,42,.45);backdrop-filter:saturate(120%) blur(2px)}
  .dialog .panel{position:relative;z-index:1;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:min(640px,96vw);max-height:85vh;display:flex;flex-direction:column}
  .dialog .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .dialog .body{padding:12px;overflow:auto}
  .dialog .foot{padding:12px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
  .dialog .row{display:flex;gap:10px;align-items:center;margin:8px 0}
  .dialog .row input, .dialog .row select{flex:1}

  /* 設定モーダル固有（トグルUI） */
  .settings .toggle{position:relative;display:inline-flex;align-items:center;width:50px;height:28px}
  .settings .toggle input{display:none}
  .settings .toggle .track{position:relative;flex:0 0 100%;height:100%;background:#e5e7eb;border-radius:999px;border:1px solid #d1d5db;transition:.2s}
  .settings .toggle .thumb{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;border:1px solid #cbd5e1;transition:.2s}
  .settings .toggle input:checked + .track{background:#2563eb;border-color:#1d4ed8}
  .settings .toggle input:checked + .track .thumb{left:calc(100% - 26px)}
  .settings .switchRow{display:flex;align-items:center;gap:12px}
  .settings .label{min-width:8em}

  /* ゲート&ローディング（リンクや許可ボタンは完全に非表示）*/
  #gate{display:none}
  #loading{max-width:960px;margin:24px auto;padding:24px;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
  pre.debug{background:#0f172a;color:#e5e7eb;padding:12px;border-radius:8px;overflow:auto;font-size:12px}
  </style>
</head>
<body>

<!-- 最小限ローディング（gateは完全非表示） -->
<div id="loading" style="display:none">
  <b>管理者画面の初期設定中...</b>
</div>

<!-- 本体UI -->
<header id="hdr" style="display:none">
  <div class="inner">
    <div class="left">
      <div class="h1">シャワー室 予約管理 <small class="muted">（管理者）</small></div>
      <div class="meta">
        <span class="pill">日時：<b id="nowLabel">—</b></span>
        <span class="pill">現在モード：<b id="modeLabel">—</b></span>
      </div>
    </div>
    <div class="right">
      <input type="date" id="datePicker" />
      <button class="ghost" id="refreshBtn">再読込</button>
      <button class="icon" id="settingsBtn" title="設定" aria-haspopup="dialog">⚙️</button>
    </div>
  </div>
</header>

<div class="container" id="main" style="display:none">
  <!-- 上：即時編集 -->
  <div class="card" id="instantCard">
    <h3 id="instantTitle">当日の予約状況</h3>
    <div class="section">
      <div id="roomsWrap" class="grid-rooms-wrap" aria-label="当日の予約状況エリア" style="padding-right:1px">
        <div id="gridRooms" class="grid-rooms">
          <div class="room-col">
            <h4 class="room-title">シャワー室1</h4>
            <div class="list" id="listRoom1"></div>
          </div>
          <div class="room-col room2">
            <h4 class="room-title">シャワー室2</h4>
            <div class="list" id="listRoom2"></div>
          </div>
        </div>
      </div>
      <div class="note">管理者は制限なく編集できます（同一人物が複数枠でもOK）。</div>
    </div>
  </div>

  <!-- 下：抽選集計 -->
  <div class="card" id="lotteryCard">
    <h3 id="lotteryTitle">明日分 抽選希望の集計</h3>
    <div class="section table-wrap">
      <table class="table" id="lotteryTable">
        <thead>
          <tr>
            <th class="left col-time">時間</th>
            <th class="center g1 vcut-thick" colspan="3">シャワー室1</th>
            <th class="center g2 vcut-thin" colspan="3">シャワー室2</th>
          </tr>
          <tr>
            <th class="left col-time">（開始–終了）</th>
            <th class="center g1 vcut-thick">第1</th>
            <th class="center g1">第2</th>
            <th class="center g1">第3</th>
            <th class="center g2 vcut-thin">第1</th>
            <th class="center g2">第2</th>
            <th class="center g2">第3</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="note">抽選受付（21:00〜翌8:00）に更新されます。祝日は平日扱いから除外。</div>
    </div>
  </div>
</div>

<!-- 編集モーダル -->
<div class="dialog" id="editDialog" role="dialog" aria-modal="true" aria-label="枠の編集">
  <div class="panel">
    <div class="head"><div>枠の編集</div><button class="ghost" id="closeEdit">閉じる</button></div>
    <div class="body">
      <div class="row"><span class="pill" id="editCurrentLabel">現在：—</span></div>
      <div class="row"><input id="editName" placeholder="氏名" /></div>
      <div class="note">※ 枠の移動や時間変更はできません。空きにする場合は各行の「クリア」を使ってください。</div>
    </div>
    <div class="foot"><button class="primary" id="editSave">保存</button></div>
  </div>
</div>

<!-- 設定モーダル（中央表示・独立スクロール） -->
<div class="dialog settings" id="settingsDialog" role="dialog" aria-modal="true" aria-label="設定">
  <div class="panel">
    <div class="head"><div>設定</div><button class="ghost" id="closeSettings">閉じる</button></div>
    <div class="body">
      <div class="row switchRow">
        <span class="label">ログイン機能</span>
        <label class="toggle"><input type="checkbox" id="loginToggle"><span class="track"><span class="thumb"></span></span></label>
      </div>
      <div class="row switchRow">
        <span class="label">端末制限</span>
        <label class="toggle"><input type="checkbox" id="deviceToggle"><span class="track"><span class="thumb"></span></span></label>
        <button class="ghost" id="registerDeviceBtn">この端末を登録</button>
      </div>
      <hr/>
      <h4>ユーザーの登録</h4>
      <div class="row">
        <input id="newUserName" placeholder="表示名" />
        <input id="newUserPin" placeholder="PIN（4桁）" maxlength="4" />
        <button class="primary" id="addUserBtn">追加</button>
      </div>
      <div class="userlist" id="userList"></div>
      <hr/>
      <div class="row">
        <span>ログイン状態：<b id="sessionUser">未ログイン</b></span>
        <button class="ghost" id="loginBtn">ログイン</button>
        <button class="ghost" id="logoutBtn">ログアウト</button>
      </div>
      <div class="note">※ デモ実装：localStorage を使用（PINは平文）。本番はサーバ＋ハッシュ化推奨。</div>
    </div>
    <div class="foot"><button class="ghost" id="settingsCloseBottom">閉じる</button></div>
  </div>
</div>

<!-- ログインモーダル -->
<div class="dialog" id="loginDialog" role="dialog" aria-modal="true" aria-label="ログイン">
  <div class="panel">
    <div class="head"><div>ログイン</div><button class="ghost" id="closeLogin">閉じる</button></div>
    <div class="body">
      <div class="row">
        <select id="loginUser"></select>
        <input id="loginPin" placeholder="PIN（4桁）" maxlength="4" />
      </div>
    </div>
    <div class="foot"><button class="primary" id="doLogin">ログイン</button></div>
  </div>
</div>

<script>
/** ========== 管理者アクセス鍵（初回 only）========== */
const ADMIN_ACCESS_KEY = "kagoshimauniv_peds";

/** ========== キー類 ========== */
const ADMIN_KEYS = { SETTINGS:'sr_admin_settings', SESSION:'sr_admin_session', DEVICE:'sr_admin_device_id' };
const KEY = { NAME:"sr_name", UID:"sr_uid", RES:"sr_reservations", LOT:"sr_lottery", PART:"sr_lot_participants" };

/** ========== SW登録（絶対パス）========== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/shower-pwa/sw.js').catch(console.error);
}

/** ========== 端末/設定ユーティリティ ========== */
function getDeviceId(){
  let v = localStorage.getItem(ADMIN_KEYS.DEVICE);
  if(!v){ v = `dev-${crypto.randomUUID()}`; localStorage.setItem(ADMIN_KEYS.DEVICE, v); }
  return v;
}
function loadSettings(){ return JSON.parse(localStorage.getItem(ADMIN_KEYS.SETTINGS)||'{}'); }
function saveSettings(s){ localStorage.setItem(ADMIN_KEYS.SETTINGS, JSON.stringify(s)); }
function ensureDefaults(){
  const s = loadSettings();
  s.loginEnabled ??= false;
  s.deviceLockEnabled ??= true;  // 既定で端末制限ON
  s.users ??= [];
  s.allowedDevices ??= [];
  saveSettings(s);
}
function allowThisDevice(){
  const s = loadSettings();
  const id = getDeviceId();
  if(!s.allowedDevices.includes(id)){ s.allowedDevices.push(id); saveSettings(s); }
}

/** ========== 初回ゲート（外部にURLや許可UIを一切出さない） ========== */
function stripKeyFromURL(){
  const url = new URL(location.href);
  url.searchParams.delete('key');
  history.replaceState(null, '', url.toString());
}
function isAllowed(){
  const s = loadSettings();
  if(!s.deviceLockEnabled) return true;
  const id = getDeviceId();
  return s.allowedDevices.includes(id);
}

/** ========== 予約/抽選ロジック ========== */
const CONFIG = { rooms:["1","2"], slotStart:"09:00", slotEnd:"21:00", slotMinutes:20,
  /* ★優先枠を明示：室1=14-16、室2=13-16 */
  priority: { "1": { start: "14:00", end: "16:00" }, "2": { start: "13:00", end: "16:00" } }
};

const z2 = n=> String(n).padStart(2,'0');
const fmtHM = d=> `${z2(d.getHours())}:${z2(d.getMinutes())}`;
const toISODateLocal = (d)=> `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
const parseHM = s=>{ const [h,m]=s.split(":").map(Number); return {h,m}; };
const addMinutes=(date,mins)=>{const d=new Date(date.getTime()); d.setMinutes(d.getMinutes()+mins);return d;};

const JP_HOLIDAYS_2025 = new Set([
  "2025-01-01","2025-01-13","2025-02-11","2025-02-23","2025-02-24","2025-03-20",
  "2025-04-29","2025-05-03","2025-05-04","2025-05-05","2025-05-06",
  "2025-07-21","2025-08-11","2025-09-15","2025-09-23","2025-10-13",
  "2025-11-03","2025-11-23","2025-11-24"
]);
function isJapaneseHoliday(dateISO){ return JP_HOLIDAYS_2025.has(dateISO); }

const qs = new URLSearchParams(location.search);
const MOCK = qs.get('mock');
const nowLocal = ()=> MOCK ? new Date(MOCK.replace(' ', 'T')) : new Date();

function modeJP(){
  const h=nowLocal().getHours();
  if(h>=8 && h<21) return {code:'INSTANT_TODAY', label:'本日分 即時予約'};
  if(h>=21) return {code:'LOTTERY_FOR_TOMORROW', label:'翌日分 抽選希望受付'};
  return {code:'LOTTERY_FOR_TODAY', label:'本日分 抽選希望受付'};
}
function targetDateForMode(code){
  const n=nowLocal();
  const today=toISODateLocal(n);
  if(code==='INSTANT_TODAY' || code==='LOTTERY_FOR_TODAY') return today;
  const t=new Date(n.getTime()); t.setDate(t.getDate()+1); return toISODateLocal(t);
}

function generateSlotsForDateRoom(dateISO, room){
  const slots=[]; const {h:sh,m:sm}=parseHM(CONFIG.slotStart); const {h:eh,m:em}=parseHM(CONFIG.slotEnd);
  const s=new Date(`${dateISO}T00:00:00`); s.setHours(sh,sm,0,0);
  const end=new Date(`${dateISO}T00:00:00`); end.setHours(eh,em,0,0);
  for(let cur=s; cur<end; cur=addMinutes(cur,CONFIG.slotMinutes)){
    const start=`${z2(cur.getHours())}:${z2(cur.getMinutes())}`;
    const e=addMinutes(cur,CONFIG.slotMinutes);
    const endtxt=`${z2(e.getHours())}:${z2(e.getMinutes())}`;
    slots.push({id:`${dateISO}_${room}_${start}`,date:dateISO,room,start,end:endtxt});
  }
  return slots;
}
function isWeekdayNonHoliday(dateISO){
  const d=new Date(`${dateISO}T00:00:00`);
  const wd=d.getDay();
  if (isJapaneseHoliday(dateISO)) return false;
  return wd>=1 && wd<=5;
}
function isPrioritySlot(slot){
  if(!isWeekdayNonHoliday(slot.date)) return false;
  const p=CONFIG.priority?.[slot.room]; if(!p) return false;
  return slot.start>=p.start && slot.start<p.end;
}

const storage={
  getRes(){return JSON.parse(localStorage.getItem(KEY.RES)||"{}");},
  setRes(o){localStorage.setItem(KEY.RES,JSON.stringify(o));},
  getLot(){return JSON.parse(localStorage.getItem(KEY.LOT)||"{}");}
};

/** ========== DOM参照 ========== */
const el={
  modeLabel:()=>document.getElementById('modeLabel'),
  nowLabel:()=>document.getElementById('nowLabel'),
  datePicker:()=>document.getElementById('datePicker'),
  refreshBtn:()=>document.getElementById('refreshBtn'),
  lotteryCard:()=>document.getElementById('lotteryCard'),
  lotteryTitle:()=>document.getElementById('lotteryTitle'),
  lotteryTbody:()=>document.querySelector('#lotteryTable tbody'),
  instantTitle:()=>document.getElementById('instantTitle'),
  listRoom1:()=>document.getElementById('listRoom1'),
  listRoom2:()=>document.getElementById('listRoom2'),
  settingsBtn:()=>document.getElementById('settingsBtn'),
  hdr:()=>document.getElementById('hdr'),
  main:()=>document.getElementById('main'),
  roomsWrap:()=>document.getElementById('roomsWrap'),
  gridRooms:()=>document.getElementById('gridRooms')
};

/** ========== スロット描画 ========== */
function currentReservation(id){ const res=storage.getRes(); return res[id] || null; }
function renderInstant(dateISO){
  const target=dateISO || el.datePicker().value;
  const res=storage.getRes();
  const lists={ '1':el.listRoom1(), '2':el.listRoom2() };
  lists['1'].innerHTML=''; lists['2'].innerHTML='';

  for(const room of CONFIG.rooms){
    const slots=generateSlotsForDateRoom(target, room);
    for(const s of slots){
      const r = res[s.id];
      const row=document.createElement('div');
      row.className='slot';
      if(isPrioritySlot(s)) row.classList.add('priority');

      const status = r? `<span class="badge ok">予約済</span>` : `<span class="badge info">空き</span>`;
      const who = r? `${r.name} <small class="note">(${r.source})</small>` : '—';

      row.innerHTML = `
        <div class="row1"><div class="time">${s.start}–${s.end}</div>${status}</div>
        <div class="row2">${who}</div>
        <div class="row3"></div>
      `;
      const acts=row.querySelector('.row3');

      const btnE=document.createElement('button');
      btnE.className='ghost'; btnE.textContent = r? '編集' : '予約追加';
      btnE.onclick=()=> openEdit(s);

      const btnC=document.createElement('button');
      btnC.className='danger'; btnC.textContent='クリア';
      btnC.onclick=()=>{
        if(!canOperate()){ alert('操作権限がありません'); return; }
        const res=storage.getRes(); const existing = res[s.id];
        if(existing && (existing.source==='instant' || existing.source==='lottery')){
          if(!confirm('【確認】この枠は一般ユーザーによって確定/応募されたものです。クリアしますか？')) return;
        }
        delete res[s.id]; storage.setRes(res); refresh();
      };

      acts.append(btnE, btnC);
      lists[room].appendChild(row);
    }
  }
  fitRoomsToViewport();
}

/** ========== 抽選（希望人数の一覧） ========== */
function renderLotteryCounts(dateISO){
  const target = dateISO || el.datePicker().value;
  const lot = (storage.getLot()[target]||[]);
  const counts={};
  for(const entry of lot){
    (entry.choices||[]).slice(0,3).forEach((slotId,idx)=>{
      counts[slotId] ||= [0,0,0];
      counts[slotId][idx]++;
    });
  }
  const slots1 = generateSlotsForDateRoom(target, "1");
  const slots2 = generateSlotsForDateRoom(target, "2");
  const tbody = el.lotteryTbody(); tbody.innerHTML='';

  for(let i=0;i<Math.max(slots1.length, slots2.length);i++){
    const s1 = slots1[i]; const s2 = slots2[i];
    if(!s1 || !s2) break;

    const c1 = counts[s1.id] || [0,0,0];
    const c2 = counts[s2.id] || [0,0,0];

    const priorityHit = isPrioritySlot(s1) || isPrioritySlot(s2);

    const tr=document.createElement('tr');
    if (priorityHit) tr.classList.add('priorityRow');
    tr.innerHTML = `
      <td class="left col-time"><span class="timecode">${s1.start}</span>–<span class="timecode">${s1.end}</span></td>
      <td class="center g1 vcut-thick">${c1[0]||'–'}</td>
      <td class="center g1">${c1[1]||'–'}</td>
      <td class="center g1">${c1[2]||'–'}</td>
      <td class="center g2 vcut-thin">${c2[0]||'–'}</td>
      <td class="center g2">${c2[1]||'–'}</td>
      <td class="center g2">${c2[2]||'–'}</td>
    `;
    tbody.appendChild(tr);
  }
}

/** ========== 編集モーダル ========== */
const dialog={
  root:()=>document.getElementById('editDialog'),
  close:()=>document.getElementById('closeEdit'),
  name:()=>document.getElementById('editName'),
  label:()=>document.getElementById('editCurrentLabel'),
  save:()=>document.getElementById('editSave')
};
let currentEditingSlot=null;

const ADMIN_UID_KEY = 'sr_admin_uid_map';
function mapNameToUID(name){
  const map = JSON.parse(localStorage.getItem(ADMIN_UID_KEY)||"{}");
  if(map[name]) return map[name];
  const uid = `admin-${crypto.randomUUID()}`;
  map[name]=uid;
  localStorage.setItem(ADMIN_UID_KEY, JSON.stringify(map));
  return uid;
}
function canOperate(){
  const s=loadSettings();
  if(!s.loginEnabled && !s.deviceLockEnabled) return true;
  const devId = getDeviceId();
  if(s.deviceLockEnabled && !s.allowedDevices.includes(devId)) return false;
  if(s.loginEnabled){
    const ses = session();
    if(!ses.userId) return false;
    if(!s.users.find(u=>u.id===ses.userId)) return false;
  }
  return true;
}
function openEdit(slot){
  if(!canOperate()){ alert('操作権限がありません（ログイン/端末制限をご確認ください）'); return; }
  currentEditingSlot=slot;
  const r=currentReservation(slot.id);
  dialog.name().value = r?.name || "";
  dialog.label().textContent = `現在：シャワー室${slot.room} ${slot.start}–${slot.end}`;
  dialog.root().style.display='flex';
  document.body.style.overflow='hidden';
}
function closeEdit(){
  dialog.root().style.display='none'; currentEditingSlot=null;
  document.body.style.overflow='';
}
// 閉じる操作の強化：ESCキー・背景クリック
(function initDialogClose(){
  document.getElementById('closeEdit').onclick=closeEdit;
  document.getElementById('editDialog').addEventListener('click', (e)=>{ if(e.target.id==='editDialog') closeEdit(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeEdit(); closeSettingsPanel(); closeLoginPanel(); }});
})();

document.getElementById('editSave').onclick=()=>{
  if(!currentEditingSlot) return;
  const name=(dialog.name().value||"").trim();
  if(!name){ alert('氏名を入力してください'); return; }
  const res=storage.getRes();
  const existing = res[currentEditingSlot.id];
  if(existing && (existing.source==='instant' || existing.source==='lottery')){
    if(!confirm('【確認】この枠は一般ユーザーによる予約/応募です。上書き保存しますか？')) return;
  }
  const uid = mapNameToUID(name);
  res[currentEditingSlot.id] = {
    userId:uid,name,
    date:currentEditingSlot.date, room:currentEditingSlot.room,
    start:currentEditingSlot.start, end:currentEditingSlot.end,
    source:"admin"
  };
  storage.setRes(res);
  closeEdit(); refresh();
};

/** ========== ヘッダー/更新 ========== */
function renderHeader(){
  const m=modeJP();
  const target = targetDateForMode(m.code);
  el.modeLabel().textContent = m.label;
  el.nowLabel().textContent = `${target} ${fmtHM(nowLocal())}`;
  el.datePicker().value = target;
  el.lotteryCard().style.display = (m.code!=='INSTANT_TODAY')? 'block':'none';
  el.instantTitle().textContent = (m.code==='INSTANT_TODAY') ? '当日の予約状況' : '明日の予約状況';
  el.lotteryTitle().textContent = `明日分 抽選希望の集計`;
}
function refresh(){ renderHeader(); renderInstant(); renderLotteryCounts(); }

/** ========== レイアウト自動フィット（スマホ幅に対して縮尺最適化） ========== */
function fitRoomsToViewport(){
  const wrap = el.roomsWrap();
  const grid = el.gridRooms();
  if(!wrap || !grid) return;

  // いったんリセットして“未スケール”の素のサイズを取得
  grid.style.transform = 'none';
  wrap.style.height = 'auto';

  const availW  = Math.floor(wrap.clientWidth);   // 利用可能幅（端欠け抑制のため丸め）
  const actualW = Math.ceil(grid.scrollWidth);    // 必要幅（小数切上げ）
  const actualH = grid.offsetHeight;              // ★未スケール時の高さ（これを基準にする）

  let scale = 1;
  if(actualW > availW){
    scale = (availW - 1) / actualW; // 右端1pxのクリップ回避
    scale = Math.max(0.70, Math.min(1, scale));
  }

  // スケール適用
  grid.style.transform = `scale(${scale})`;
  // ★wrapの高さは“未スケール高さ×scale”で算出（getBoundingClientRectは使わない）
  const h = Math.ceil(actualH * scale) + 2; // 2pxマージン
  wrap.style.height = `${h}px`;
}
    grid.style.transform = `scale(${scale})`;

    // スケール後の高さを確保（+2pxでボーダー分の逃げ）
    const h = Math.ceil(grid.getBoundingClientRect().height * scale) + 2;
    wrap.style.height = `${h}px`;
  });
} // 下限0.75まで縮小

  grid.style.transform = `scale(${scale})`;
  // 元の高さにスケールを掛けてラップ要素に確保
  const h = grid.offsetHeight * scale;
  wrap.style.height = `${h}px`;
}
window.addEventListener('resize', fitRoomsToViewport, {passive:true});

/** ========== ゲート駆動（URLや許可UIは見せない） ========== */
(function gate(){
  ensureDefaults();

  const params = new URLSearchParams(location.search);
  const key = params.get('key');

  if(key){
    document.getElementById('loading').style.display = 'block';
    if(key === ADMIN_ACCESS_KEY){
      allowThisDevice();
      setTimeout(()=>{
        stripKeyFromURL();
        document.getElementById('loading').style.display = 'none';
        boot();
      }, 200);
      return;
    } else {
      // 不正キー時も何も出さない（情報を一切漏らさない）
      return;
    }
  }

  if(isAllowed()){
    boot();
  } else {
    // 端末未登録時：画面には何も出さない（静かにブロック）
    return;
  }
})();

/** ========== 起動後の紐付け ========== */
function session(){ return JSON.parse(localStorage.getItem(ADMIN_KEYS.SESSION)||'{}'); }
function setSession(obj){ if(obj) localStorage.setItem(ADMIN_KEYS.SESSION, JSON.stringify(obj)); else localStorage.removeItem(ADMIN_KEYS.SESSION); renderSessionUI(); }

const settingsDialogUI = {
  root: ()=>document.getElementById('settingsDialog'),
  loginToggle: ()=>document.getElementById('loginToggle'),
  deviceToggle: ()=>document.getElementById('deviceToggle'),
  registerDeviceBtn: ()=>document.getElementById('registerDeviceBtn'),
  addUserBtn: ()=>document.getElementById('addUserBtn'),
  newUserName: ()=>document.getElementById('newUserName'),
  newUserPin: ()=>document.getElementById('newUserPin'),
  userList: ()=>document.getElementById('userList'),
  sessionUser: ()=>document.getElementById('sessionUser'),
  loginBtn: ()=>document.getElementById('loginBtn'),
  logoutBtn: ()=>document.getElementById('logoutBtn'),
  close: ()=>document.getElementById('closeSettings'),
  closeBottom: ()=>document.getElementById('settingsCloseBottom')
};
function renderUserList(){
  const s=loadSettings();
  const box=settingsDialogUI.userList();
  box.innerHTML='';
  (s.users||[]).forEach(u=>{
    const row=document.createElement('div');
    row.className='useritem';
    row.innerHTML=`<span class="name">${u.name}</span><span class="note">(ID: ${u.id})</span>`;
    const del=document.createElement('button');
    del.className='ghost'; del.textContent='削除';
    del.onclick=()=>{
      const st=loadSettings();
      st.users = (st.users||[]).filter(x=>x.id!==u.id);
      saveSettings(st);
      if(session().userId===u.id) setSession(null);
      renderUserList(); renderSessionUI();
    };
    row.appendChild(del);
    box.appendChild(row);
  });
}
function renderSessionUI(){
  const s=loadSettings();
  const ses=session();
  const user = (s.users||[]).find(u=>u.id===ses.userId);
  settingsDialogUI.sessionUser().textContent = user? user.name : '未ログイン';
  const sel=document.getElementById('loginUser');
  sel.innerHTML='';
  (s.users||[]).forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u.id; opt.textContent=u.name; sel.appendChild(opt);
  });
}
function populateSettings(){
  ensureDefaults();
  const s=loadSettings();
  settingsDialogUI.loginToggle().checked = !!s.loginEnabled;
  settingsDialogUI.deviceToggle().checked = !!s.deviceLockEnabled;
  renderUserList();
  renderSessionUI();
  const devId=getDeviceId();
  settingsDialogUI.registerDeviceBtn().textContent = s.allowedDevices?.includes(devId)? 'この端末は登録済' : 'この端末を登録';
}

function openSettingsPanel(){ settingsDialogUI.root().style.display='flex'; document.body.style.overflow='hidden'; }
function closeSettingsPanel(){ settingsDialogUI.root().style.display='none'; document.body.style.overflow=''; }
function openLoginPanel(){ document.getElementById('loginDialog').style.display='flex'; document.body.style.overflow='hidden'; }
function closeLoginPanel(){ document.getElementById('loginDialog').style.display='none'; document.body.style.overflow=''; }

function boot(){
  el.hdr().style.display='block';
  el.main().style.display='block';

  document.getElementById('settingsBtn').onclick=()=>{ populateSettings(); openSettingsPanel(); };
  settingsDialogUI.close().onclick=closeSettingsPanel;
  settingsDialogUI.closeBottom().onclick=closeSettingsPanel;
  settingsDialogUI.root().addEventListener('click', (e)=>{ if(e.target.id==='settingsDialog') closeSettingsPanel(); });

  settingsDialogUI.loginToggle().onchange=()=>{ const s=loadSettings(); s.loginEnabled = settingsDialogUI.loginToggle().checked; saveSettings(s); };
  settingsDialogUI.deviceToggle().onchange=()=>{ const s=loadSettings(); s.deviceLockEnabled = settingsDialogUI.deviceToggle().checked; saveSettings(s); };
  settingsDialogUI.registerDeviceBtn().onclick=()=>{ const s=loadSettings(); s.allowedDevices ||= []; const id=getDeviceId(); if(!s.allowedDevices.includes(id)) s.allowedDevices.push(id); saveSettings(s); populateSettings(); };
  settingsDialogUI.addUserBtn().onclick=()=>{ const name=(settingsDialogUI.newUserName().value||'').trim(); const pin=(settingsDialogUI.newUserPin().value||'').trim(); if(!name||pin.length!==4){ alert('名前と4桁PINを入力してください'); return; } const s=loadSettings(); s.users ||= []; s.users.push({id:`u-${crypto.randomUUID()}`, name, pin}); saveSettings(s); settingsDialogUI.newUserName().value=''; settingsDialogUI.newUserPin().value=''; renderUserList(); renderSessionUI(); };
  settingsDialogUI.loginBtn().onclick=()=>{ const s=loadSettings(); if(!(s.users||[]).length){ alert('先にユーザーを登録してください'); return; } openLoginPanel(); };
  settingsDialogUI.logoutBtn().onclick=()=> setSession(null);

  document.getElementById('closeLogin').onclick=closeLoginPanel;
  document.getElementById('loginDialog').addEventListener('click', (e)=>{ if(e.target.id==='loginDialog') closeLoginPanel(); });
  document.getElementById('doLogin').onclick=()=>{ const s=loadSettings(); const id=document.getElementById('loginUser').value; const pin=(document.getElementById('loginPin').value||'').trim(); const u=(s.users||[]).find(x=>x.id===id); if(!u){ alert('ユーザーが見つかりません'); return; } if(u.pin!==pin){ alert('PINが違います'); return; } setSession({userId:u.id}); closeLoginPanel(); populateSettings(); };

  document.getElementById('refreshBtn').onclick=()=> refresh();
  document.getElementById('datePicker').onchange=()=>{ const picked=document.getElementById('datePicker').value; renderInstant(picked); renderLotteryCounts(picked); };

  refresh();
  setInterval(()=>{
    const m=modeJP();
    const target = targetDateForMode(m.code);
    el.modeLabel().textContent = m.label;
    el.nowLabel().textContent = `${target} ${fmtHM(nowLocal())}`;
    el.instantTitle().textContent = (m.code==='INSTANT_TODAY') ? '当日の予約状況' : '明日の予約状況';
    el.lotteryCard().style.display = (m.code!=='INSTANT_TODAY')? 'block':'none';
  }, 10000);
}
</script>
</body>
</html>
